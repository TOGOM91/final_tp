name: Deploy Frontend to VPS and Backend to Render

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    # Ã‰tape 1: RÃ©cupÃ©ration du code
    - name: Checkout code
      uses: actions/checkout@v4
      
    # Ã‰tape 2: Setup Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          frontend/package-lock.json
          backend/package-lock.json

    # Ã‰tape 3: Build du Frontend
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci --audit=false
        
    - name: Build frontend
      run: |
        cd frontend
        npm run build
      env:
        REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}

    # Ã‰tape 4: DÃ©ploiement Backend sur Render
    - name: Deploy Backend to Render
      run: |
        echo "ğŸš€ DÃ©ploiement du backend sur Render..."
        curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
        echo "âœ… DÃ©clenchement du dÃ©ploiement Render effectuÃ©"

    # Ã‰tape 5: DÃ©ploiement Frontend sur VPS
    - name: Setup SSH for VPS
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

    - name: Add VPS to known hosts
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts

    - name: Sync Frontend build to VPS
      run: |
        echo "ğŸ“¡ Synchronisation du build frontend vers le VPS..."
        rsync -avz --delete \
          -e "ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30" \
          frontend/build/ \
          ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ secrets.VPS_DEPLOY_PATH }}/current/
        echo "âœ… Synchronisation frontend terminÃ©e"

    - name: Restart Frontend with PM2
      run: |
        echo "ğŸ”„ RedÃ©marrage de l'application avec PM2..."
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 \
          ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
          "cd ${{ secrets.VPS_DEPLOY_PATH }} && pm2 reload ecosystem.config.js --update-env || pm2 start ecosystem.config.js"
        echo "âœ… RedÃ©marrage PM2 effectuÃ©"

    # Ã‰tape 6: VÃ©rification finale
    - name: Verify deployment
      run: |
        echo "ğŸ‰ DÃ‰PLOIEMENT TERMINÃ‰ AVEC SUCCÃˆS"
        echo "========================================"
        echo "ğŸŒ Frontend URL: http://${{ secrets.VPS_HOST }}"
        echo "ğŸ”™ Backend URL: ${{ secrets.RENDER_BACKEND_URL }}"
        echo "â° DÃ©ploiement terminÃ© Ã : $(date)"
        echo "========================================"